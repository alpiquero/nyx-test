name: Nyx workflow
on: [push]
# Avoid running multiple pipelines concurrently to avoid overlapping releases and tags
concurrency:
  group: project
  cancel-in-progress: false

jobs:
  infer-version:
    name: Publish the release (if any) with Nyx
    runs-on: ubuntu-latest
    steps:
    - name: Git checkout
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Run nyx Infer
      uses: mooltiverse/nyx-github-action@main
      with:
        command: infer
      env:
        NYX_VERBOSITY: 'INFO'

    - name: Generate Artifacts with Nyx
      uses: mooltiverse/nyx-github-action@main
      with:
        command: make
      env:
        NYX_VERBOSITY: 'INFO'

    - name: Mark Artifacts with Nyx
      uses: mooltiverse/nyx-github-action@main
      with:
        command: mark
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        NYX_VERBOSITY: 'INFO'

    - name: Nyx publish
      id: nyx
      uses: mooltiverse/nyx-github-action@main
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        NYX_VERBOSITY: 'INFO'
      with:
        command: 'publish'